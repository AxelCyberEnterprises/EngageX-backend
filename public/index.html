<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>WebSocket Video Stream</title>
</head>

<body>
	<h2>WebSocket Video Streaming</h2>
	<video id="videoPreview" autoplay></video>
	<button id="startBtn">Start Recording</button>
	<button id="stopBtn" disabled>Stop Recording</button>
	<p id="status">Status: Waiting...</p>

	<script>
		let mediaRecorder;
		let socket;
		let chunkCounter = 0;

		document.getElementById("startBtn").addEventListener("click", async function () {
			try {
				const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
				document.getElementById("videoPreview").srcObject = stream;

				// Initialize WebSocket
				socket = new WebSocket(`ws://localhost:8000/ws/socket_server/`);

				socket.onopen = () => {
					console.log("WebSocket Connected");
					document.getElementById("status").textContent = "Status: Recording...";
				};

				socket.onmessage = (e) => {
					let data = JSON.parse(e.data);
					console.log("Server Acknowledgment:", data);
				};

				socket.onerror = (error) => {
					console.error("WebSocket Error:", error);
				};

				socket.onclose = () => {
					console.log("WebSocket Disconnected");
					document.getElementById("status").textContent = "Status: Disconnected";
				};

				// Start MediaRecorder
				mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });
				mediaRecorder.ondataavailable = (event) => {
					if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
						chunkCounter++;
						socket.send(event.data);
						console.log(`Sent Chunk ${chunkCounter}`);
					}
				};

				mediaRecorder.start(30000); // Record in 30-second chunks
				setInterval(() => {
					mediaRecorder.stop();
					mediaRecorder.start(30000); // Restart recording every 30 seconds
				}, 30000);

				document.getElementById("startBtn").disabled = true;
				document.getElementById("stopBtn").disabled = false;
			} catch (error) {
				console.error("Camera Access Error:", error);
			}
		});

		document.getElementById("stopBtn").addEventListener("click", function () {
			mediaRecorder.stop();
			socket.close();
			document.getElementById("status").textContent = "Status: Stopped";
			document.getElementById("startBtn").disabled = false;
			document.getElementById("stopBtn").disabled = true;
		});
	</script>
</body>

</html>